<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CloudBrowser Source: application_config.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.readable.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">CloudBrowser</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="cloudbrowser.html">cloudbrowser</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.html">app</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="cloudbrowser.app.AppConfig.html">AppConfig</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.GoogleStrategy.html">GoogleStrategy</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.LocalStrategy.html">LocalStrategy</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.User.html">User</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.VirtualBrowser.html">VirtualBrowser</a>
						</li>
						
						<li>
							<a href="cloudbrowser.ServerConfig.html">ServerConfig</a>
						</li>
						
						<li>
							<a href="cloudbrowser.Util.html">Util</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="events.list.html" class="dropdown-toggle" data-toggle="dropdown">Events<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="cloudbrowser.app.AppConfig.html#event:Added">Added</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.AppConfig.html#event:Removed">Removed</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.VirtualBrowser.html#event:Renamed">Renamed</a>
						</li>
						
						<li>
							<a href="cloudbrowser.app.VirtualBrowser.html#event:Shared">Shared</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: application_config.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript linenums">(function() {
  var AppConfig, Crypto, getParentMountPoint, hashPassword, _ref;

  Crypto = require("crypto");

  _ref = require("./utils"), getParentMountPoint = _ref.getParentMountPoint, hashPassword = _ref.hashPassword;

  /**
      @description Configuration details of the application including details
      in the app_config.json file of the application
      @class cloudbrowser.app.AppConfig
      @param {BrowserServer} bserver
      @param {cloudbrowser}  cloudbrowserContext
      @fires cloudbrowser.app.AppConfig#Added
      @fires cloudbrowser.app.AppConfig#Removed
  */

  AppConfig = (function() {
    var _privates;

    _privates = [];

    function AppConfig(bserver, cloudbrowserContext) {
      var creator, parentMountPoint;
      Object.defineProperty(this, "_index", {
        value: _privates.length
      });
      parentMountPoint = getParentMountPoint(bserver.mountPoint);
      creator = bserver.creator != null ? new cloudbrowserContext.app.User(bserver.creator.email, bserver.creator.ns) : null;
      _privates.push({
        bserver: bserver,
        creator: creator,
        creatorJson: creator ? creator.toJson() : null,
        cloudbrowserContext: cloudbrowserContext,
        parentMountPoint: parentMountPoint,
        parentApplication: bserver.server.applicationManager.find(parentMountPoint),
        localStrategy: new cloudbrowserContext.app.LocalStrategy(bserver, cloudbrowserContext),
        googleStrategy: new cloudbrowserContext.app.GoogleStrategy(bserver)
      });
    }

    /**
        Gets the absolute URL at which the application is hosted/mounted.    
        @instance
        @method getUrl
        @memberOf cloudbrowser.app.AppConfig
        @returns {String}
    */

    AppConfig.prototype.getUrl = function() {
      var config;
      config = _privates[this._index].bserver.server.config;
      return "http://" + config.domain + ":" + config.port + _privates[this._index].parentMountPoint;
    };

    /**
        Gets the description of the application as provided in the
        app_config.json configuration file.    
        @instance
        @method getDescription
        @memberOf cloudbrowser.app.AppConfig
        @return {String}
    */

    AppConfig.prototype.getDescription = function() {
      return _privates[this._index].parentApplication.description;
    };

    /**
        Gets the path relative to the root URL at which the application was mounted.     
        @instance
        @method getMountPoint
        @memberOf cloudbrowser.app.AppConfig
        @return {String}
    */

    AppConfig.prototype.getMountPoint = function() {
      return _privates[this._index].parentMountPoint;
    };

    /**
        A list of all the registered users of the application.          
        @instance
        @method getUsers
        @memberOf cloudbrowser.app.AppConfig
        @param {userListCallback} callback
    */

    AppConfig.prototype.getUsers = function(callback) {
      var dbName, mongoInterface, userClass;
      mongoInterface = _privates[this._index].bserver.server.mongoInterface;
      dbName = _privates[this._index].parentApplication.dbName;
      userClass = _privates[this._index].cloudbrowserContext.app.User;
      return mongoInterface.getUsers(dbName, function(users) {
        var user, userList, _i, _len;
        userList = [];
        for (_i = 0, _len = users.length; _i &lt; _len; _i++) {
          user = users[_i];
          userList.push(new userClass(user.email, user.ns));
        }
        return callback(userList);
      });
    };

    /**
        Creates a new instance of this application.    
        @instance
        @method createVirtualBrowser
        @memberOf cloudbrowser.app.AppConfig
        @param {errorCallback} callback
    */

    AppConfig.prototype.createVirtualBrowser = function(callback) {
      var creatorJson, parentApp;
      parentApp = _privates[this._index].parentApplication;
      creatorJson = _privates[this._index].creatorJson;
      return parentApp.browsers.create(parentApp, creatorJson, function(err, bsvr) {
        return callback(err);
      });
    };

    /**
        Gets all the instances of the application associated with the current user.    
        @instance
        @method getVirtualBrowsers
        @memberOf cloudbrowser.app.AppConfig
        @param {instanceListCallback} callback
    */

    AppConfig.prototype.getVirtualBrowsers = function(callback) {
      var permissionManager, vbClass,
        _this = this;
      vbClass = _privates[this._index].cloudbrowserContext.app.VirtualBrowser;
      permissionManager = _privates[this._index].bserver.server.permissionManager;
      return permissionManager.getBrowserPermRecs(_privates[this._index].creatorJson, _privates[this._index].parentMountPoint, function(browserRecs) {
        var browser, browserRec, browsers, id;
        browsers = [];
        for (id in browserRecs) {
          browserRec = browserRecs[id];
          browser = _privates[_this._index].parentApplication.browsers.find(id);
          browsers.push(new vbClass(browser, _privates[_this._index].creator, _privates[_this._index].cloudbrowserContext));
        }
        return callback(browsers);
      });
    };

    /**
        Registers a listener on the application for an event associated with the current user.     
        @instance
        @method addEventListener
        @memberOf cloudbrowser.app.AppConfig
        @param {String} event 
        @param {instanceCallback} callback
    */

    AppConfig.prototype.addEventListener = function(event, callback) {
      var permissionManager, vbClass,
        _this = this;
      permissionManager = _privates[this._index].bserver.server.permissionManager;
      vbClass = _privates[this._index].cloudbrowserContext.app.VirtualBrowser;
      return permissionManager.findAppPermRec(_privates[this._index].creatorJson, _privates[this._index].parentMountPoint, function(appRec) {
        if (appRec) {
          if (event === "Added") {
            return appRec.on(event, function(id) {
              return callback(new vbClass(_privates[_this._index].parentApplication.browsers.find(id), _privates[_this._index].creator, _privates[_this._index].cloudbrowserContext));
            });
          } else {
            return appRec.on(event, function(id) {
              return callback(id);
            });
          }
        }
      });
    };

    /**
        Checks if a user is already registered/signed up with the application.     
        @instance
        @method isUserRegistered
        @memberOf cloudbrowser.app.AppConfig
        @param {User} user
        @param {booleanCallback} callback
    */

    AppConfig.prototype.isUserRegistered = function(user, callback) {
      var dbName, mongoInterface;
      mongoInterface = _privates[this._index].bserver.server.mongoInterface;
      dbName = _privates[this._index].parentApplication.dbName;
      return mongoInterface.findUser(user.toJson(), dbName, function(user) {
        if (user) {
          return callback(true);
        } else {
          return callback(false);
        }
      });
    };

    /**
        Sends a password reset link to the user at their registered email ID.    
        @instance
        @method sendResetLink
        @memberOf cloudbrowser.app.AppConfig
        @param {booleanCallback} callback
    */

    AppConfig.prototype.sendResetLink = function(user, callback) {
      var appUrl, config, dbName, mongoInterface, util,
        _this = this;
      mongoInterface = _privates[this._index].bserver.server.mongoInterface;
      dbName = _privates[this._index].parentApplication.dbName;
      config = _privates[this._index].bserver.server.config;
      appUrl = "http://" + config.domain + ":" + config.port + _privates[this._index].parentMountPoint;
      util = _privates[this._index].cloudbrowserContext.getUtil();
      return mongoInterface.findUser(user.toJson(), dbName, function(userRec) {
        if (userRec) {
          return Crypto.randomBytes(32, function(err, token) {
            var esc_email, message, subject;
            if (err) throw err;
            token = token.toString('hex');
            esc_email = encodeURIComponent(userRec.email);
            subject = "Link to reset your CloudBrowser password";
            message = "You have requested to change your password." + " If you want to continue click " + ("&lt;a href='" + appUrl + "/password_reset?resettoken=" + token + "&resetuser=" + esc_email + "'>reset&lt;/a>.") + " If you have not requested a change in password then take no action.";
            return util.sendEmail(userRec.email, subject, message, function() {
              return mongoInterface.setUser(user.toJson(), dbName, {
                status: "reset_password",
                token: token
              }, function(result) {
                return callback(true);
              });
            });
          });
        } else {
          return callback(false);
        }
      });
    };

    /**
        Resets the password for a valid user request.     
        A boolean is passed as an argument to indicate success/failure.
        @instance
        @method resetPassword
        @memberOf cloudbrowser.app.AppConfig
        @param {String}   password     The new plaintext password provided by the user.
        @param {booleanCallback} callback
    */

    AppConfig.prototype.resetPassword = function(password, callback) {
      var dbName, mongoInterface;
      mongoInterface = _privates[this._index].bserver.server.mongoInterface;
      dbName = _privates[this._index].parentApplication.dbName;
      return _privates[this._index].bserver.getSessions(function(sessionIDs) {
        if (sessionIDs.length) {
          return mongoInterface.getSession(sessionIDs[0], function(session) {
            return mongoInterface.findUser({
              email: session.resetuser,
              ns: 'local'
            }, dbName, function(userRec) {
              if (userRec && userRec.status === "reset_password" && userRec.token === session.resettoken) {
                return mongoInterface.unsetUser({
                  email: userRec.email,
                  ns: userRec.ns
                }, dbName, {
                  token: "",
                  status: ""
                }, function() {
                  return hashPassword({
                    password: password
                  }, function(result) {
                    return mongoInterface.setUser({
                      email: userRec.email,
                      ns: userRec.ns
                    }, dbName, {
                      key: result.key.toString('hex'),
                      salt: result.salt.toString('hex')
                    }, function() {
                      return callback(true);
                    });
                  });
                });
              } else {
                return callback(false);
              }
            });
          });
        } else {
          return callback(false);
        }
      });
    };

    /**
        Logs out all connected clients from the current application.
        @instance
        @method logout
        @memberOf cloudbrowser.app.AppConfig
    */

    AppConfig.prototype.logout = function() {
      var appUrl, config;
      config = _privates[this._index].bserver.server.config;
      appUrl = "http://" + config.domain + ":" + config.port + _privates[this._index].parentMountPoint;
      return _privates[this._index].bserver.redirect(appUrl + "/logout");
    };

    /**
        Returns an instance of local strategy for authentication
        @instance
        @method getLocalStrategy
        @memberOf cloudbrowser.app.AppConfig
        @return {cloudbrowser.app.LocalStrategy}
    */

    AppConfig.prototype.getLocalStrategy = function() {
      return _privates[this._index].localStrategy;
    };

    /**
        Returns an instance of google strategy for authentication
        @instance
        @method getGoogleStrategy
        @memberOf cloudbrowser.app.AppConfig
        @return {cloudbrowser.app.GoogleStrategy}
    */

    AppConfig.prototype.getGoogleStrategy = function() {
      return _privates[this._index].googleStrategy;
    };

    return AppConfig;

  })();

  module.exports = AppConfig;

  /**
      Browser Added event
      @event cloudbrowser.app.AppConfig#Added
      @type {cloudbrowser.app.VirtualBrowser}
  */

  /**
      Browser Removed event
      @event cloudbrowser.app.AppConfig#Removed
      @type {Number}
  */

}).call(this);
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="copyright">
		DocStrap Copyright © 2012-2013 The contributors to the JSDoc3 and DocStrap projects.
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a>
		on Fri Jun 21 2013 10:11:12 GMT-0400 (EDT) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:true,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
