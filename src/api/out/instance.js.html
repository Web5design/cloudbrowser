<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: instance.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: instance.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>(function() {
  var Instance, User;

  User = require('./user');

  Instance = (function() {
    /**
        @class Instance
        @classdesc CloudBrowser application instances a.k.a. virtual browsers.
    */
    function Instance(browser, userContext) {
      var application, creator, permissionManager,
        _this = this;
      application = browser.server.applicationManager.find(browser.mountPoint);
      permissionManager = browser.server.permissionManager;
      if (browser.creator != null) {
        creator = new User(browser.creator.email, browser.creator.ns);
      }
      /**
          @member {Number} id
          @description The (hash) ID of the instance.    
          @memberOf Instance
          @instance
      */
      this.id = browser.id;
      /**
          @description The name of the instance.
          @member {String} name    
          @memberOf Instance
          @instance
      */
      this.name = browser.name;
      /**
          @description The date of creation of the instance.
          @member {Date} dateCreated    
          @memberOf Instance
          @instance
      */
      this.dateCreated = browser.dateCreated;
      /**
          Gets the user that created the instance.
          @method getCreator
          @memberof Instance
          @instance
          @return {User}
      */
      this.getCreator = function() {
        return creator;
      };
      /**
          Closes the instance.
          @method close
          @memberof Instance
          @instance
          @param {errorCallback} callback
      */
      this.close = function(callback) {
        return application.browsers.close(browser, userContext.toJson(), callback);
      };
      /**
          Registers a listener on the instance for an event. The system supported events are "Shared" and "Renamed".
          @method addEventListener
          @memberof Instance
          @instance
          @param {String}   event
          @param {errorCallback} callback
      */
      this.addEventListener = function(event, callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          if (browserRec != null) {
            if (event === "Shared") {
              return browser.on(event, function(user, list) {
                return callback(null);
              });
            } else if (event === "Renamed") {
              return browser.on(event, function(name) {
                return callback(null, name);
              });
            }
          } else {
            return callback(new Error("You do not have the permission to perform the requested action"));
          }
        });
      };
      /**
          Gets all users that have the permission only to read and write to the instance.
          @method getReaderWriters
          @memberof Instance
          @instance
          @param {userListCallback} callback
      */
      this.getReaderWriters = function(callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          var readerwriterRec, readerwriterRecs, users, _i, _len;
          if (browserRec != null) {
            readerwriterRecs = browser.getUsersInList('readwrite');
            users = [];
            for (_i = 0, _len = readerwriterRecs.length; _i &lt; _len; _i++) {
              readerwriterRec = readerwriterRecs[_i];
              if (!browser.findUserInList(readerwriterRec.user, 'own')) {
                users.push(new User(readerwriterRec.user.email, readerwriterRec.user.ns));
              }
            }
            return callback(users);
          } else {
            return callback(null);
          }
        });
      };
      /**
          Gets the number of users that have the permission only to read and write to the instance.
          @method getNumReaderWriters
          @memberof Instance
          @instance
          @param {numberCallback} callback
      */
      this.getNumReaderWriters = function(callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          var numReadWriters, readerwriterRec, readerwriterRecs, _i, _len;
          if (browserRec != null) {
            readerwriterRecs = browser.getUsersInList('readwrite');
            numReadWriters = readerwriterRecs.length;
            for (_i = 0, _len = readerwriterRecs.length; _i &lt; _len; _i++) {
              readerwriterRec = readerwriterRecs[_i];
              if (browser.findUserInList(readerwriterRec.user, 'own')) {
                numReadWriters--;
              }
            }
            return callback(numReadWriters);
          } else {
            return callback(null);
          }
        });
      };
      /**
          Gets the number of users that own the instance.
          @method getNumOwners
          @memberof Instance
          @instance
          @param {numberCallback} callback
      */
      this.getNumOwners = function(callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          var ownerRecs;
          if (browserRec != null) {
            ownerRecs = browser.getUsersInList('own');
            return callback(ownerRecs.length);
          } else {
            return callback(null);
          }
        });
      };
      /**
          Gets all users that are the owners of the instance
          @method getOwners
          @memberof Instance
          @instance
          @param {userListCallback} callback
      */
      this.getOwners = function(callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          var ownerRec, ownerRecs, users, _i, _len;
          if (browserRec != null) {
            ownerRecs = browser.getUsersInList('own');
            users = [];
            for (_i = 0, _len = ownerRecs.length; _i &lt; _len; _i++) {
              ownerRec = ownerRecs[_i];
              users.push(new User(ownerRec.user.email, ownerRec.user.ns));
            }
            return callback(users);
          } else {
            return callback(null);
          }
        });
      };
      /**
          Checks if the user is a reader-writer of the instance.
          @method isReaderWriter
          @memberof Instance
          @instance
          @param {User} user
          @param {booleanCallback} callback
      */
      this.isReaderWriter = function(user, callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          if (browserRec != null) {
            if (browser.findUserInList(user.toJson(), 'readwrite') && !browser.findUserInList(user.toJson(), 'own')) {
              return callback(true);
            } else {
              return callback(false);
            }
          } else {
            return callback(null);
          }
        });
      };
      /**
          Checks if the user is an owner of the instance
          @method isOwner
          @memberof Instance
          @instance
          @param {User} user
          @param {booleanCallback} callback
      */
      this.isOwner = function(user, callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          if (browserRec != null) {
            if (browser.findUserInList(user.toJson(), 'own')) {
              return callback(true);
            } else {
              return callback(false);
            }
          } else {
            return callback(null);
          }
        });
      };
      /**
          Checks if the user has permissions to perform a set of actions on the instance.
          @method checkPermissions
          @memberof Instance
          @instance
          @param {Object} permTypes Permissible members are 'own', 'remove', 'readwrite', 'readonly'. The values of these properties must be set to true to check for the corresponding permission.
          @param {booleanCallback} callback
      */
      this.checkPermissions = function(permTypes, callback) {
        return permissionManager.findBrowserPermRec(userContext.toJson(), browser.mountPoint, browser.id, function(browserRec) {
          var type, v;
          if (browserRec) {
            for (type in permTypes) {
              v = permTypes[type];
              if (!browserRec.permissions[type] || typeof browserRec.permissions[type] === "undefined") {
                callback(false);
                return;
              }
            }
            return callback(true);
          } else {
            return callback(false);
          }
        });
      };
      /**
          Grants the user a set of permissions on the instance.
          @method grantPermissions
          @memberof Instance
          @instance
          @param {Object} permTypes Permissible members are 'own', 'remove', 'readwrite', 'readonly'. The values of these properties must be set to true to check for the corresponding permission.
          @param {User} user 
          @param {errorCallback} callback
      */
      this.grantPermissions = function(permissions, user, callback) {
        return this.checkPermissions({
          own: true
        }, function(hasPermission) {
          if (hasPermission) {
            user = user.toJson();
            return permissionManager.findAppPermRec(user, browser.mountPoint, function(appRec) {
              if (appRec != null) {
                return permissionManager.addBrowserPermRec(user, browser.mountPoint, browser.id, permissions, function(browserRec) {
                  return browser.addUserToLists(user, permissions, function() {
                    return callback(null);
                  });
                });
              } else {
                return browser.server.httpServer.addPermRec(user, browser.mountPoint, function() {
                  return permissionManager.addBrowserPermRec(user, browser.mountPoint, browser.id, permissions, function(browserRec) {
                    return browser.addUserToLists(user, permissions, function() {
                      return callback(null);
                    });
                  });
                });
              }
            });
          } else {
            return callback(new Error("You do not have the permission to perform the requested action"));
          }
        });
      };
      /**
          Renames the instance and emits an event "Renamed" that can be listened for by registering a listener on the instance.
          @method rename
          @memberof Instance
          @instance
          @param {String} newName
      */
      this.rename = function(newName) {
        return this.checkPermissions({
          own: true
        }, function(hasPermission) {
          if (hasPermission) {
            this.name = newName;
            browser.name = newName;
            return browser.emit('Renamed', newName);
          }
        });
      };
      /**
          @description The owners of the instance.
          @member {Array&lt;User>} owners
          @memberOf Instance
          @instance
      */
      this.getOwners(function(owners) {
        return _this.owners = owners;
      });
      /**
          @description The users that can read and write to the instance.
          @member {Array&lt;User>} collaborators
          @memberOf Instance
          @instance
      */
      this.getReaderWriters(function(collaborators) {
        return _this.collaborators = collaborators;
      });
    }

    return Instance;

  })();

  module.exports = Instance;

}).call(this);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Classes</h3><ul><li><a href="GoogleStrategy.html">GoogleStrategy</a></li><li><a href="Instance.html">Instance</a></li><li><a href="LocalStrategy.html">LocalStrategy</a></li><li><a href="User.html">User</a></li></ul><h3>Namespaces</h3><ul><li><a href="CloudBrowser.html">CloudBrowser</a></li><li><a href="CloudBrowser.app.html">app</a></li><li><a href="CloudBrowser.auth.html">auth</a></li><li><a href="CloudBrowser.component.html">component</a></li><li><a href="CloudBrowser.server.html">server</a></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.2.0-dev</a> on Wed Jun 05 2013 20:29:52 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
